/*
 * battery_values.c
 *
 *  Created on: Dec 9, 2014
 *      Author: serkan
 */
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include "lpc_types.h"
#include "lpc177x_8x_gpio.h"
#include "lpc177x_8x_pinsel.h"
#include "lpc177x_8x_uart.h"
#include "lpc177x_8x_dac.h"
#include "lpc177x_8x_gpdma.h"
#include "lpc177x_8x_clkpwr.h"
#include "UMDShared.h"
#include "AppCommon.h"
#include "debug_frmwrk.h"
#include "monitor.h"
#include "Serial.h"
#include "GuiConsole.h"
#include "UartInt.h"
#include "BSP.h"
#include "Battery.h"

// This values are captured with 8bit ADC and so they include a lof of repeated values //
// :TODO: Re-Captures this table with 12bit ADC again //
battery_table_type battery_table[BATTERY_TABLE_COUNT] = {
	{	100				,	0	,	16160	},
	{	99.6666666667	,	1	,	16152	},
	{	99.3333333333	,	2	,	15987	},
	{	99				,	3	,	15987	},
	{	98.6666666667	,	4	,	15987	},
	{	98.3333333333	,	5	,	15987	},
	{	98				,	6	,	15821	},
	{	97.6666666667	,	7	,	15821	},
	{	97.3333333333	,	8	,	15821	},
	{	97				,	9	,	15821	},
	{	96.6666666667	,	10	,	15821	},
	{	96.3333333333	,	11	,	15821	},
	{	96				,	12	,	15821	},
	{	95.6666666667	,	13	,	15821	},
	{	95.3333333333	,	14	,	15821	},
	{	95				,	15	,	15821	},
	{	94.6666666667	,	16	,	15821	},
	{	94.3333333333	,	17	,	15821	},
	{	94				,	18	,	15738	},
	{	93.6666666667	,	19	,	15655	},
	{	93.3333333333	,	20	,	15655	},
	{	93				,	21	,	15655	},
	{	92.6666666667	,	22	,	15655	},
	{	92.3333333333	,	23	,	15655	},
	{	92				,	24	,	15655	},
	{	91.6666666667	,	25	,	15655	},
	{	91.3333333333	,	26	,	15655	},
	{	91				,	27	,	15655	},
	{	90.6666666667	,	28	,	15655	},
	{	90.3333333333	,	29	,	15655	},
	{	90				,	30	,	15572	},
	{	89.6666666667	,	31	,	15572	},
	{	89.3333333333	,	32	,	15572	},
	{	89				,	33	,	15572	},
	{	88.6666666667	,	34	,	15572	},
	{	88.3333333333	,	35	,	15490	},
	{	88				,	36	,	15490	},
	{	87.6666666667	,	37	,	15490	},
	{	87.3333333333	,	38	,	15490	},
	{	87				,	39	,	15490	},
	{	86.6666666667	,	40	,	15490	},
	{	86.3333333333	,	41	,	15490	},
	{	86				,	42	,	15490	},
	{	85.6666666667	,	43	,	15490	},
	{	85.3333333333	,	44	,	15490	},
	{	85				,	45	,	15490	},
	{	84.6666666667	,	46	,	15407	},
	{	84.3333333333	,	47	,	15324	},
	{	84				,	48	,	15324	},
	{	83.6666666667	,	49	,	15324	},
	{	83.3333333333	,	50	,	15324	},
	{	83				,	51	,	15324	},
	{	82.6666666667	,	52	,	15324	},
	{	82.3333333333	,	53	,	15324	},
	{	82				,	54	,	15324	},
	{	81.6666666667	,	55	,	15324	},
	{	81.3333333333	,	56	,	15324	},
	{	81				,	57	,	15324	},
	{	80.6666666667	,	58	,	15324	},
	{	80.3333333333	,	59	,	15324	},
	{	80				,	60	,	15241	},
	{	79.6666666667	,	61	,	15241	},
	{	79.3333333333	,	62	,	15241	},
	{	79				,	63	,	15241	},
	{	78.6666666667	,	64	,	15158	},
	{	78.3333333333	,	65	,	15158	},
	{	78				,	66	,	15158	},
	{	77.6666666667	,	67	,	15158	},
	{	77.3333333333	,	68	,	15158	},
	{	77				,	69	,	15158	},
	{	76.6666666667	,	70	,	15158	},
	{	76.3333333333	,	71	,	15158	},
	{	76				,	72	,	15158	},
	{	75.6666666667	,	73	,	15158	},
	{	75.3333333333	,	74	,	15075	},
	{	75				,	75	,	15075	},
	{	74.6666666667	,	76	,	15075	},
	{	74.3333333333	,	77	,	14993	},
	{	74				,	78	,	14993	},
	{	73.6666666667	,	79	,	14993	},
	{	73.3333333333	,	80	,	14993	},
	{	73				,	81	,	14993	},
	{	72.6666666667	,	82	,	14993	},
	{	72.3333333333	,	83	,	14993	},
	{	72				,	84	,	14993	},
	{	71.6666666667	,	85	,	14993	},
	{	71.3333333333	,	86	,	14993	},
	{	71				,	87	,	14993	},
	{	70.6666666667	,	88	,	14993	},
	{	70.3333333333	,	89	,	14910	},
	{	70				,	90	,	14910	}	,
	{	69.6666666667	,	91	,	14910	},
	{	69.3333333333	,	92	,	14910	},
	{	69				,	93	,	14910	},
	{	68.6666666667	,	94	,	14910	},
	{	68.3333333333	,	95	,	14910	},
	{	68				,	96	,	14910	},
	{	67.6666666667	,	97	,	14910	},
	{	67.3333333333	,	98	,	14827	},
	{	67				,	99	,	14827	},
	{	66.6666666667	,	100	,	14827	},
	{	66.3333333333	,	101	,	14827	},
	{	66				,	102	,	14827	},
	{	65.6666666667	,	103	,	14827	},
	{	65.3333333333	,	104	,	14827	},
	{	65				,	105	,	14827	},
	{	64.6666666667	,	106	,	14827	},
	{	64.3333333333	,	107	,	14827	},
	{	64				,	108	,	14827	},
	{	63.6666666667	,	109	,	14827	},
	{	63.3333333333	,	110	,	14744	},
	{	63				,	111	,	14661	},
	{	62.6666666667	,	112	,	14661	},
	{	62.3333333333	,	113	,	14661	},
	{	62				,	114	,	14661	},
	{	61.6666666667	,	115	,	14661	},
	{	61.3333333333	,	116	,	14661	},
	{	61				,	117	,	14661	},
	{	60.6666666667	,	118	,	14661	},
	{	60.3333333333	,	119	,	14661	},
	{	60				,	120	,	14661	},
	{	59.6666666667	,	121	,	14578	},
	{	59.3333333333	,	122	,	14661	},
	{	59				,	123	,	14578	},
	{	58.6666666667	,	124	,	14496	},
	{	58.3333333333	,	125	,	14496	},
	{	58				,	126	,	14496	},
	{	57.6666666667	,	127	,	14496	},
	{	57.3333333333	,	128	,	14496	},
	{	57				,	129	,	14496	},
	{	56.6666666667	,	130	,	14496	},
	{	56.3333333333	,	131	,	14496	},
	{	56				,	132	,	14496	},
	{	55.6666666667	,	133	,	14496	},
	{	55.3333333333	,	134	,	14496	},
	{	55				,	135	,	14496	},
	{	54.6666666667	,	136	,	14496	},
	{	54.3333333333	,	137	,	14330	},
	{	54				,	138	,	14330	},
	{	53.6666666667	,	139	,	14413	},
	{	53.3333333333	,	140	,	14330	},
	{	53				,	141	,	14330	},
	{	52.6666666667	,	142	,	14330	},
	{	52.3333333333	,	143	,	14330	},
	{	52				,	144	,	14330	},
	{	51.6666666667	,	145	,	14330	},
	{	51.3333333333	,	146	,	14330	},
	{	51				,	147	,	14330	},
	{	50.6666666667	,	148	,	14330	},
	{	50.3333333333	,	149	,	14330	},
	{	50				,	150	,	14247	},
	{	49.6666666667	,	151	,	14247	},
	{	49.3333333333	,	152	,	14247	},
	{	49				,	153	,	14247	},
	{	48.6666666667	,	154	,	14247	},
	{	48.3333333333	,	155	,	14247	},
	{	48				,	156	,	14247	},
	{	47.6666666667	,	157	,	14247	},
	{	47.3333333333	,	158	,	14247	},
	{	47				,	159	,	14164	},
	{	46.6666666667	,	160	,	14164	},
	{	46.3333333333	,	161	,	14164	},
	{	46				,	162	,	14164	},
	{	45.6666666667	,	163	,	14164	},
	{	45.3333333333	,	164	,	14164	},
	{	45				,	165	,	14164	},
	{	44.6666666667	,	166	,	14164	},
	{	44.3333333333	,	167	,	14164	},
	{	44				,	168	,	14164	},
	{	43.6666666667	,	169	,	14164	},
	{	43.3333333333	,	170	,	14164	},
	{	43				,	171	,	14164	},
	{	42.6666666667	,	172	,	14164	},
	{	42.3333333333	,	173	,	14081	},
	{	42				,	174	,	14081	},
	{	41.6666666667	,	175	,	13998	},
	{	41.3333333333	,	176	,	13998	},
	{	41				,	177	,	13998	},
	{	40.6666666667	,	178	,	13998	},
	{	40.3333333333	,	179	,	13998	},
	{	40				,	180	,	13998	},
	{	39.6666666667	,	181	,	13998	},
	{	39.3333333333	,	182	,	13998	},
	{	39				,	183	,	13998	},
	{	38.6666666667	,	184	,	13998	},
	{	38.3333333333	,	185	,	13998	},
	{	38				,	186	,	13998	},
	{	37.6666666667	,	187	,	13998	},
	{	37.3333333333	,	188	,	13998	},
	{	37				,	189	,	13998	},
	{	36.6666666667	,	190	,	13998	},
	{	36.3333333333	,	191	,	13998	},
	{	36				,	192	,	13998	},
	{	35.6666666667	,	193	,	13998	},
	{	35.3333333333	,	194	,	13998	},
	{	35				,	195	,	13998	},
	{	34.6666666667	,	196	,	13916	},
	{	34.3333333333	,	197	,	13833	},
	{	34				,	198	,	13833	},
	{	33.6666666667	,	199	,	13833	},
	{	33.3333333333	,	200	,	13833	},
	{	33				,	201	,	13833	},
	{	32.6666666667	,	202	,	13833	},
	{	32.3333333333	,	203	,	13833	},
	{	32				,	204	,	13833	},
	{	31.6666666667	,	205	,	13833	},
	{	31.3333333333	,	206	,	13833	},
	{	31				,	207	,	13833	},
	{	30.6666666667	,	208	,	13750	},
	{	30.3333333333	,	209	,	13750	},
	{	30				,	210	,	13750	},
	{	29.6666666667	,	211	,	13750	},
	{	29.3333333333	,	212	,	13750	},
	{	29				,	213	,	13750	},
	{	28.6666666667	,	214	,	13750	},
	{	28.3333333333	,	215	,	13667	},
	{	28				,	216	,	13667	},
	{	27.6666666667	,	217	,	13667	},
	{	27.3333333333	,	218	,	13667	},
	{	27				,	219	,	13667	},
	{	26.6666666667	,	220	,	13667	},
	{	26.3333333333	,	221	,	13667	},
	{	26				,	222	,	13667	},
	{	25.6666666667	,	223	,	13667	},
	{	25.3333333333	,	224	,	13667	},
	{	25				,	225	,	13667	},
	{	24.6666666667	,	226	,	13667	},
	{	24.3333333333	,	227	,	13667	},
	{	24				,	228	,	13667	},
	{	23.6666666667	,	229	,	13667	},
	{	23.3333333333	,	230	,	13667	},
	{	23				,	231	,	13584	},
	{	22.6666666667	,	232	,	13667	},
	{	22.3333333333	,	233	,	13584	},
	{	22				,	234	,	13584	},
	{	21.6666666667	,	235	,	13584	},
	{	21.3333333333	,	236	,	13584	},
	{	21				,	237	,	13584	},
	{	20.6666666667	,	238	,	13584	},
	{	20.3333333333	,	239	,	13584	},
	{	20				,	240	,	13584	},
	{	19.6666666667	,	241	,	13584	},
	{	19.3333333333	,	242	,	13584	},
	{	19				,	243	,	13584	},
	{	18.6666666667	,	244	,	13584	},
	{	18.3333333333	,	245	,	13584	},
	{	18				,	246	,	13584	},
	{	17.6666666667	,	247	,	13501	},
	{	17.3333333333	,	248	,	13501	},
	{	17				,	249	,	13501	},
	{	16.6666666667	,	250	,	13501	},
	{	16.3333333333	,	251	,	13501	},
	{	16				,	252	,	13501	},
	{	15.6666666667	,	253	,	13501	},
	{	15.3333333333	,	254	,	13501	},
	{	15				,	255	,	13501	},
	{	14.6666666667	,	256	,	13501	},
	{	14.3333333333	,	257	,	13501	},
	{	14				,	258	,	13336	},
	{	13.6666666667	,	259	,	13336	},
	{	13.3333333333	,	260	,	13336	},
	{	13				,	261	,	13336	},
	{	12.6666666667	,	262	,	13336	},
	{	12.3333333333	,	263	,	13336	},
	{	12				,	264	,	13336	},
	{	11.6666666667	,	265	,	13336	},
	{	11.3333333333	,	266	,	13336	},
	{	11				,	267	,	13253	},
	{	10.6666666667	,	268	,	13170	},
	{	10.3333333333	,	269	,	13170	},
	{	10				,	270	,	13170	},
	{	9.6666666667	,	271	,	13170	},
	{	9.3333333333	,	272	,	13170	},
	{	9				,	273	,	13170	},
	{	8.6666666667	,	274	,	13170	},
	{	8.3333333333	,	275	,	13004	},
	{	8				,	276	,	13004	},
	{	7.6666666667	,	277	,	13004	},
	{	7.3333333333	,	278	,	13004	},
	{	7				,	279	,	13004	},
	{	6.6666666667	,	280	,	13004	},
	{	6.3333333333	,	281	,	13004	},
	{	6				,	282	,	12922	},
	{	5.6666666667	,	283	,	12922	},
	{	5.3333333333	,	284	,	12922	},
	{	5				,	285	,	12839	},
	{	4.6666666667	,	286	,	12839	},
	{	4.3333333333	,	287	,	12839	},
	{	4				,	288	,	12839	},
	{	3.6666666667	,	289	,	12839	},
	{	3.3333333333	,	290	,	12756	},
	{	3				,	291	,	12673	},
	{	2.6666666667	,	292	,	12673	},
	{	2.3333333333	,	293	,	12673	},
	{	2				,	294	,	12590	},
	{	1.6666666667	,	295	,	12507	},
	{	1.3333333333	,	296	,	12507	},
	{	1				,	297	,	12507	},
	{	0.6666666667	,	298	,	12342	},
	{	0.3333333333	,	299	,	12342	},
	{	0				,	300	,	12330	}
};

uint8_t BSP_get_percentage(uint32_t adc_raw_val) 
{
	volatile uint16_t indx = 0;
	uint8_t batteryPercentage = 0;
	uint32_t readPackVoltageMV = BAT_RAWADC_2_PACK_MV(adc_raw_val);

	TRACEM("adc_raw(%u), pack(%u mV)\n", adc_raw_val, readPackVoltageMV);
	// Use battery_table for percentage calculation //
	if( (battery_table[0].bat_voltage/2) <= readPackVoltageMV) {
		batteryPercentage = battery_table[0].capacity;
	}
	else if((battery_table[BATTERY_TABLE_COUNT-1].bat_voltage/2) >= readPackVoltageMV) {
		batteryPercentage = (int8_t)battery_table[BATTERY_TABLE_COUNT-1].capacity;
	}
	else {
		for(indx = BATTERY_TABLE_COUNT-1; indx != 0; indx--)
			if(readPackVoltageMV < (battery_table[indx].bat_voltage/2))
				break;
		batteryPercentage = battery_table[indx+1].capacity;
		TRACEM("%s()-> indx(%u), percentage(%lf)\n", __FUNCTION__, indx, battery_table[indx+1].capacity);
	}
	
	return batteryPercentage;
} 

uint32_t BAT_RAWADC_2_PACK_MV(uint32_t adc_raw_val) 
{
	uint32_t pin_val_MV = __RAW_ADC_TO_MV(adc_raw_val);
	return (pin_val_MV * (ADC_DIVIDER_HIGH_RES + ADC_DIVIDER_LOW_RES))/ADC_DIVIDER_LOW_RES;
}
